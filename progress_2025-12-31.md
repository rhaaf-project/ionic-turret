# Progress Session - 2025-12-31

## Must Check (Always First)
- [x] `always_first_thing.txt` - Checked ✓
- [x] `always_accept.bat` - Checked ✓  
- [x] `AUTORUN.md` - Checked ✓

---

## Session Info
- **Date**: 2025-12-31 14:18+07:00
- **Agents**: Antigravity (Gemini)
- **Focus**: Laravel Authentication Restructure

---

## Progress

### ✅ Successful
1. Identified Laravel location: `/var/www/html/smartX/`
2. Identified database: PostgreSQL `smartx_db` (postgres/smartx2025)
3. Found root cause of login error: **demo1 password was NOT bcrypt hashed**
4. Found users table with `use_ext` field for SIP extension assignment
5. Found extensions table with `user_id` FK to users
6. Verified architecture:
   - Server 171: Laravel + PostgreSQL (Filament CMS)
   - Server 172: Asterisk PBX
7. **FIXED demo1 password** → now bcrypt `$2y$12$e6q...`
8. **VERIFIED LOGIN API WORKS** ✅

### ❌ Failed/Issues (RESOLVED)
1. ~~User `demo1@smartx.local` has corrupted password hash~~ → FIXED ✅
2. Extensions 6002-6023 have no `user_id` assignment (not critical for now)

---

## Login API Test Result

```bash
curl -X POST http://103.154.80.171/api/login \
  -d '{"email":"demo1@smartx.local","password":"Maja1234"}'
```

**Response:**
```json
{
  "token": "36|ZyY8abfQJVX31uYRA2jRdFGgeu4kQRwCvF5nCErX23f7c3cb",
  "user": {
    "id": 5,
    "name": "demo1", 
    "email": "demo1@smartx.local",
    "use_ext": "6001"
  }
}
```

---

## Database State (After Fix)

### Users Table
| id | name  | email              | pw_type    | use_ext |
|----|-------|-------------------|------------|---------|
| 4  | admin | admin@smartx.local | BCRYPT ✓   | 6000    |
| 5  | demo1 | demo1@smartx.local | BCRYPT ✓   | 6001    |
| 6  | demo2 | demo2@smartx.local | BCRYPT ✓   | 6002    |
| 7  | demo3 | demo3@smartx.local | BCRYPT ✓   | 6003    |
| 8  | demo4 | demo4@smartx.local | BCRYPT ✓   | 6004    |

---

## Next Steps
1. ✅ ~~Fix demo1 password to bcrypt~~ DONE
2. ✅ ~~CMS User management~~ DONE - UserResource.php created
3. ✅ ~~Extension sync to 172~~ VERIFIED WORKING
4. ✅ ~~Script cleanup~~ DONE - 81 files → 40 files
5. Test from browser full flow

---

## CMS User Management

Created `UserResource.php` with:
- Password field optional on edit (only required on create)
- Auto-hash via `Hash::make()` 
- Extension dropdown selector from extensions table

---

## Extension Sync (Verified ✅)

**Architecture:**
- CMS (171) creates extension in PostgreSQL
- Extension Model triggers `AsteriskService::addExtension()`
- AsteriskService SSH to 172 → creates pjsip endpoint

**Verified:**
- PostgreSQL (171): 24 extensions (6000-6023)
- Asterisk (172): Same endpoints visible

---

## Larkon Folder Cleanup

Removed: 41 duplicate/junk files
- Old check scripts (check_171, check_auth_*, etc)
- Duplicate fix scripts (fix_demo1_v2, fix_nat2, etc)
- Temp folders (6000, 6001, 6002, 6003)
- Junk files (`bcrypt('Maja1234')]`, `n`)

---

## Call Drop Fix (6000↔6010)

**Problem**: Calls between WebRTC (6000) and Softphone (6010) disconnect immediately after answer.

**Root Cause**: Encryption mismatch - WebRTC uses DTLS/SRTP, Softphone uses no encryption. Asterisk couldn't bridge.

**Fix Applied**:
1. Created new `pjsip_wizard.conf` with templates
2. WebRTC template (6000-6009): `webrtc=yes`, `dtls_auto_generate_cert=yes`
3. Softphone template (6010-6020): `webrtc=no`, `media_encryption=no`
4. Both have: `media_encryption_optimistic=yes` for bridging

**Result**: Asterisk can now transcrypt between SRTP↔RTP automatically.





